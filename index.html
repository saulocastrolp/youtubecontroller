<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Music Connect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet">
    <script>
        let API_URL = "https://youtubecontroller.vercel.app/api";

        async function handleAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get("access_token");

            if (accessToken) {
                console.log("ğŸ”¹ Token recebido na URL:", accessToken);
                localStorage.setItem("access_token", accessToken);
                window.history.replaceState({}, document.title, "/"); // Remove o token da URL
                getUserInfo();
            } else {
                console.warn("âš ï¸ Nenhum token encontrado na URL.");
            }
        }



        async function sendCommand(endpoint) {
            const accessToken = localStorage.getItem("access_token");

            if (!accessToken) {
                console.warn("âš ï¸ UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...");
                authenticate();
                return;
            }

            await fetch(`${API_URL}/${endpoint}`, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                },
            });
        }

        async function authenticate() {
            window.location.href = `${API_URL}/login`;
        }

        async function getStatus() {
            const accessToken = localStorage.getItem("access_token");

            if (!accessToken) {
                console.warn("âš ï¸ Token ausente. Status nÃ£o pode ser carregado.");
                return;
            }

            try {
                const response = await fetch(`${API_URL}/status`, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    },
                });

                const data = await response.json();

                if (data.error) {
                    console.warn("âš ï¸ Token invÃ¡lido. Redirecionando para login...");
                    //localStorage.removeItem("access_token");
                    authenticate();
                } else {
                    document.getElementById("music-title").innerText = data.title || "Nenhuma mÃºsica tocando";
                    document.getElementById("artist-name").innerText = data.channel || "";
                }
            } catch (error) {
                console.error("Erro ao obter status:", error);
            }
        }

        async function getUserInfo() {
            const accessToken = localStorage.getItem("access_token");
            console.log("ğŸ” Enviando token para a API:", accessToken);


            if (!accessToken) {
                console.warn("âš ï¸ Nenhum token armazenado. UsuÃ¡rio nÃ£o autenticado.");
                return;
            }

            try {
                const response = await fetch(`${API_URL}/user`, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    },
                });

                const data = await response.json();

                if (data.error) {
                    console.warn("âš ï¸ Token expirado ou invÃ¡lido. Tentando renovar...");

                    // Se o backend retornou um novo token, armazenamos ele no localStorage
                    if (data.new_access_token) {
                        console.log("ğŸ”„ Atualizando token de acesso...");
                        localStorage.setItem("access_token", data.new_access_token);
                        return getUserInfo(); // Chama novamente com o novo token
                    }

                    console.warn("ğŸš« Token invÃ¡lido. Redirecionando para login...");
                    //setTimeout(authenticate, 2000);
                } else {
                    document.getElementById("login-btn").style.display = "none";
                    document.getElementById("user-info").style.display = "flex";
                    document.getElementById("user-name").innerText = data.name;
                    document.getElementById("user-photo").src = data.picture;
                }
            } catch (error) {
                console.error("Erro ao obter dados do usuÃ¡rio:", error);
            }
        }



        async function sync() {
            console.log("ğŸ”„ Sincronizar nÃ£o implementado ainda.");
        }

        async function transferPlayback() {
            console.log("ğŸ“² TransferÃªncia de reproduÃ§Ã£o nÃ£o implementada ainda.");
        }

        window.onload = function () {
            handleAuthCallback();
            getUserInfo();
            getStatus();
        };

        setInterval(() => {
            getStatus();
        }, 10000);
    </script>
    <style>
        #user-info {
            display: none;
            align-items: center;
            gap: 10px;
        }
        #user-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> YouTube Music Connect </h1>
        <br/>

        <div id="user-info">
            <img id="user-photo" alt="Foto do UsuÃ¡rio">
            <span id="user-name"></span>
        </div>

        <button class="btn btn-dark" id="login-btn" onclick="authenticate()">ğŸ”‘ Login</button>
        <br/>
        <h2 id="music-title">Nenhuma mÃºsica tocando...</h2>
        <h3 id="artist-name"></h3>
    
        <div class="btn-group">
            <button class="btn btn-dark" onclick="sync()">ğŸ”„ Sincronizar</button>
            <button class="btn btn-dark" onclick="transferPlayback()">ğŸ“² Transferir ReproduÃ§Ã£o</button>
        </div>
        <hr/>
        <div class="btn-group">
            <button class="btn btn-dark" onclick="sendCommand('play')">â–¶ï¸ Play</button>
            <button class="btn btn-dark" onclick="sendCommand('pause')">â¸ï¸ Pause</button>
            <button class="btn btn-dark" onclick="sendCommand('previous')">â®ï¸ Anterior</button>
            <button class="btn btn-dark" onclick="sendCommand('next')">â­ï¸ PrÃ³xima</button>
        </div>
        <hr/>
        <div class="btn-group">
            <button class="btn btn-dark" onclick="sendCommand('like')">â¤ï¸ Curtir</button>
            <button class="btn btn-dark" onclick="sendCommand('dislike')">ğŸ‘ NÃ£o Curtir</button>
            <button class="btn btn-dark" onclick="sendCommand('shuffle')">ğŸ”€ AleatÃ³rio</button>
            <button class="btn btn-dark" onclick="sendCommand('repeat')">ğŸ” Repetir</button>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
