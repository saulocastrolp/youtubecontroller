<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Music Connect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png">
    <script>
        let API_URL = "https://youtubeconnect.app.br/api";

        async function handleAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get("access_token");

            if (accessToken) {
                console.log("ğŸ”¹ Token recebido na URL:", accessToken);
                localStorage.setItem("access_token", accessToken);
                window.history.replaceState({}, document.title, "/"); // Remove o token da URL
                getUserInfo();
            } else {
                console.warn("âš ï¸ Nenhum token encontrado na URL.");
            }
        }



        async function sendCommand(endpoint) {
            const accessToken = localStorage.getItem("access_token");

            if (!accessToken) {
                console.warn("âš ï¸ UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...");
                authenticate();
                return;
            }

            try {
                console.log(`ğŸ“¡ Enviando comando: ${endpoint}`);
                const response = await fetch(`${API_URL}/${endpoint}`, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    },
                });

                const data = await response.json();
                console.log("âœ… Resposta do servidor:", data.message);
            } catch (error) {
                console.error("âŒ Erro ao enviar comando:", error);
            }
        }


        async function authenticate() {
            window.location.href = `${API_URL}/login`;
        }

        async function getStatus() {
            const accessToken = localStorage.getItem("access_token");

            if (!accessToken) {
                console.warn("âš ï¸ Token ausente. Status nÃ£o pode ser carregado.");
                return;
            }

            try {
                const response = await fetch(`${API_URL}/status`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });

                const data = await response.json();

                if (data.error) {
                    console.warn("âš ï¸ Token invÃ¡lido. Redirecionando para login...");
                    authenticate();
                } else {
                    document.getElementById("music-title").innerText = data.title || "Nenhuma mÃºsica tocando";
                    document.getElementById("artist-name").innerText = data.channel || "";
                }

                console.log(`ğŸµ MÃºsica atualizada: ${data.title} - ${data.channel}`);
            } catch (error) {
                console.error("âŒ Erro ao obter status:", error);
            }
        }

        async function getUserInfo() {
            let accessToken = localStorage.getItem("access_token");
            console.log("ğŸ” Enviando token para a API:", accessToken);


            if (!accessToken) {
                console.warn("âš ï¸ Nenhum token armazenado. UsuÃ¡rio nÃ£o autenticado.");
                return;
            }

            try {
                const response = await fetch(`${API_URL}/user`, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    },
                });

                const data = await response.json();

                if (data.error) {
                    console.warn("âš ï¸ Token expirado ou invÃ¡lido para obter as informaÃ§Ãµes do usuÃ¡rio. Tentando renovar...");

                    // Se o backend retornou um novo token, armazenamos ele no localStorage
                    if (data.new_access_token) {
                        console.log("ğŸ”„ Atualizando token de acesso...");
                        localStorage.setItem("access_token", data.new_access_token);
                        return getUserInfo(); // Chama novamente com o novo token
                    }

                    console.warn("ğŸš« Token invÃ¡lido para renovar os dados do usuÃ¡rio. Redirecionando para login...");
                    //setTimeout(authenticate, 2000);
                } else {
                    document.getElementById("login-btn").style.display = "none";
                    document.getElementById("user-info").style.display = "flex";
                    document.getElementById("user-name").innerText = data.name;
                    document.getElementById("user-photo").src = data.picture;
                }
            } catch (error) {
                console.error("Erro ao obter dados do usuÃ¡rio:", error);
            }
        }

        async function getCurrentTrack() {
            const accessToken = localStorage.getItem("access_token");

            if (!accessToken) {
                console.warn("âš ï¸ UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...");
                authenticate();
                return;
            }

            try {
                console.log("ğŸµ Obtendo mÃºsica atual...");
                const response = await fetch(`${API_URL}/getCurrentTrack`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });

                const data = await response.json();
                currentVideoId = data.videoId; // ğŸ”¥ Armazena o ID para controle
                document.getElementById("music-title").innerText = data.title; // ğŸ”¥ Atualiza o tÃ­tulo na interface

                console.log("ğŸµ MÃºsica atual:", data.title, "ID:", data.videoId);
            } catch (error) {
                console.error("âŒ Erro ao buscar a mÃºsica atual:", error);
            }
        }


        async function sync() {
            const accessToken = localStorage.getItem("access_token");

            if (!accessToken) {
                console.warn("âš ï¸ UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...");
                authenticate();
                return;
            }

            try {
                console.log("ğŸ”„ Sincronizando reproduÃ§Ã£o...");
                const response = await fetch(`${API_URL}/sync?device=${navigator.userAgent.includes("Mobile") ? "celular" : "computador"}`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });

                const data = await response.json();
                console.log("âœ… SincronizaÃ§Ã£o:", data.message, "Dispositivo:", data.device);
            } catch (error) {
                console.error("âŒ Erro ao sincronizar reproduÃ§Ã£o:", error);
            }
        }

        async function transferPlayback() {
            const accessToken = localStorage.getItem("access_token");

            if (!accessToken) {
                console.warn("âš ï¸ UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...");
                authenticate();
                return;
            }

            try {
                console.log("ğŸ“² Transferindo reproduÃ§Ã£o...");
                const response = await fetch(`${API_URL}/transfer`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });

                const data = await response.json();
                console.log("âœ… TransferÃªncia realizada:", data.message, "Novo dispositivo:", data.device);
            } catch (error) {
                console.error("âŒ Erro ao transferir reproduÃ§Ã£o:", error);
            }
        }

        window.onload = function () {
            handleAuthCallback();
            getUserInfo();
            getStatus();
            getCurrentTrack();
        };

        setInterval(() => {
            getStatus();
            getCurrentTrack();
        }, 5000);
    </script>
    <style>
        #user-info {
            display: none;
            align-items: center;
            gap: 10px;
        }
        #user-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="logo.png" alt="Logomarca" title="YouTube Music Connect" class="logo img-fluid"/>
        <br/>
        <h1> YouTube Music Connect </h1>
        <br/>

        <div id="user-info">
            <img id="user-photo" alt="Foto do UsuÃ¡rio">
            <span id="user-name"></span>
        </div>

        <button class="btn btn-dark" id="login-btn" onclick="authenticate()">ğŸ”‘ Login</button>
        <br/>
        <div class="container-musica-artista">
            <h2 id="music-title">Nenhuma mÃºsica tocando...</h2>
            <h3 id="artist-name"></h3>
        </div>
        
    
        <div class="btn-group">
            <button class="btn btn-dark" onclick="sync()">ğŸ”„ Sincronizar</button>
            <button class="btn btn-dark" onclick="transferPlayback()">ğŸ“² Transferir ReproduÃ§Ã£o</button>
        </div>
        <hr/>
        <div class="btn-group">
            <button class="btn btn-dark" onclick="sendCommand('play')">â–¶ï¸ Play</button>
            <button class="btn btn-dark" onclick="sendCommand('pause?videoId=' + currentVideoId)">â¸ï¸ Pause</button>
            <button class="btn btn-dark" onclick="sendCommand('previous?videoId=' + currentVideoId)">â®ï¸ Anterior</button>
            <button class="btn btn-dark" onclick="sendCommand('next?videoId=' + currentVideoId)">â­ï¸ PrÃ³xima</button>
        </div>
        <hr/>
        <div class="btn-group">
            <button class="btn btn-dark" onclick="sendCommand('like?videoId=' + currentVideoId)">â¤ï¸ Curtir</button>
            <button class="btn btn-dark" onclick="sendCommand('dislike?videoId=' + currentVideoId)">ğŸ‘ NÃ£o Curtir</button>
            <button class="btn btn-dark" onclick="sendCommand('shuffle')">ğŸ”€ AleatÃ³rio</button>
            <button class="btn btn-dark" onclick="sendCommand('repeat?videoId=' + currentVideoId)">ğŸ” Repetir</button>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
